html, body.page-map { height: 100%; overflow: hidden; }
body.page-map { display: flex; flex-direction: column; }
.page-map .nav-header { position: relative; flex-shrink: 0; z-index: 100; }

.map-viewport {
  position: relative;
  flex: 1;
  background: var(--bg-secondary);
  overflow: hidden;
}

.map-controls,
.map-legend,
.map-hint {
  position: absolute;
  z-index: 50;
  display: flex;
  align-items: center;
  background: var(--bg-secondary);
  border: 1px solid var(--border-default);
  border-radius: var(--radius-lg);
  box-shadow: var(--shadow-lg);
  backdrop-filter: blur(12px);
}

[data-theme="light"] .map-controls,
[data-theme="light"] .map-legend,
[data-theme="light"] .map-hint { background: rgba(255, 255, 255, 0.95); }

.map-controls {
  top: 16px;
  left: 16px;
  gap: 12px;
  padding: 10px 14px;
}

.map-legend {
  bottom: 16px;
  left: 16px;
  gap: 8px;
  padding: 8px 12px;
}

.map-hint {
  bottom: 16px;
  right: 16px;
  gap: 8px;
  padding: 10px 16px;
  box-shadow: var(--shadow-md);
  font-size: 13px;
  color: var(--text-muted);
}

[data-theme="light"] .map-hint { color: #4b5563; }
.map-hint i { color: var(--accent); }

.control-group { display: flex; align-items: center; gap: 8px; }
.zoom-controls { gap: 6px; }

.control-label {
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 12px;
  font-weight: 600;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.control-label i { font-size: 14px; color: var(--accent); }

.control-select {
  appearance: none;
  padding: 10px 36px 10px 14px;
  min-width: 180px;
  background: var(--bg-tertiary) url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%2371717a' d='M2.5 4.5L6 8l3.5-3.5'/%3E%3C/svg%3E") no-repeat right 12px center;
  border: 1px solid var(--border-default);
  border-radius: var(--radius-md);
  color: var(--text-primary);
  font-size: 14px;
  font-weight: 500;
  cursor: pointer;
  transition: all var(--transition-fast);
}

.control-select:hover,
.control-select:focus { border-color: var(--accent); }
.control-select:focus { outline: none; box-shadow: 0 0 0 3px var(--accent-muted); }

.control-divider { width: 1px; height: 28px; background: var(--border-default); }

.control-btn,
.zoom-display {
  display: grid;
  place-items: center;
  background: var(--bg-tertiary);
  border: 1px solid var(--border-default);
  border-radius: var(--radius-md);
}

.control-btn {
  width: 36px;
  height: 36px;
  color: var(--text-secondary);
  font-size: 14px;
  transition: all var(--transition-fast);
}

.control-btn:hover { background: var(--bg-elevated); border-color: var(--accent); color: var(--accent); }
.control-btn:active { transform: scale(0.95); }

.zoom-display {
  min-width: 54px;
  padding: 8px 10px;
  font-family: var(--font-mono);
  font-size: 13px;
  font-weight: 500;
  color: var(--text-primary);
  text-align: center;
}

.legend-chip {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 8px 14px;
  background: var(--bg-tertiary);
  border: 1px solid var(--border-default);
  border-radius: 100px;
  font-size: 13px;
  font-weight: 500;
  color: var(--text-secondary);
  cursor: pointer;
  transition: all var(--transition-fast);
  user-select: none;
}

.legend-chip:hover { border-color: var(--border-strong); }
.legend-chip.active { color: var(--text-primary); }
.legend-chip.off { opacity: 0.5; }
.legend-chip.off .chip-dot { opacity: 0.3; }

.chip-dot { width: 10px; height: 10px; border-radius: 50%; background: var(--text-muted); }
.chip-any .chip-dot { background: linear-gradient(135deg, var(--accent), #60a5fa); }
.chip-stalker .chip-dot { background: var(--accent); }
.chip-bandit .chip-dot { background: #ef4444; }

.map-canvas {
  position: absolute;
  inset: 0;
  width: 100%;
  height: 100%;
  overflow: auto;
  touch-action: none;
  overscroll-behavior: contain;
  scrollbar-width: none;
  background: 
    radial-gradient(circle at 20% 30%, rgba(16, 185, 129, 0.03) 0%, transparent 50%),
    radial-gradient(circle at 80% 70%, rgba(59, 130, 246, 0.03) 0%, transparent 50%),
    var(--bg-primary);
}

.map-canvas::-webkit-scrollbar { display: none; }
.map-canvas.pannable { cursor: grab; }
.map-canvas.pannable.dragging { cursor: grabbing; }

.map-frame {
  position: relative;
  width: var(--frame-w, 1372px);
  height: var(--frame-h, 2000px);
  margin: 0 auto;
  user-select: none;
  -webkit-user-drag: none;
}

.map-image {
  position: absolute;
  inset: 0;
  width: 100%;
  height: 100%;
  object-fit: cover;
  filter: saturate(1.02) contrast(1.02);
  pointer-events: none;
}

.map-image.error { filter: grayscale(0.9) brightness(0.7); }
.map-frame.loading .map-image { opacity: 0.6; }

.tiles-layer {
  position: absolute;
  inset: 0;
  pointer-events: none;
  overflow: hidden;
}

.tiles-layer img.tile {
  position: absolute;
  display: block;
  transform-origin: top left;
  will-change: transform, width, height;
  image-rendering: auto;
  backface-visibility: hidden;
}

.markers-layer { position: absolute; inset: 0; pointer-events: none; }

.marker {
  --pin-scale: 0.7;
  position: absolute;
  transform: translate(-50%, -100%);
  z-index: 10;
  pointer-events: auto;
  appearance: none;
  background: transparent;
  border: none;
  padding: 0;
  margin: 0;
  line-height: 0;
  cursor: pointer;
}

.marker:focus { outline: none; }
.marker:focus-visible { outline: 2px solid var(--accent); outline-offset: 4px; border-radius: var(--radius-sm); }
.marker:hover, .marker:focus-within, .marker.active { z-index: 1000; }

.marker .pin { position: relative; display: flex; align-items: center; justify-content: center; }

.marker .pin::before {
  content: '';
  position: absolute;
  inset: -4px;
  border-radius: 50%;
  background: var(--accent);
  opacity: 0;
  transform: scale(0.8);
  transition: all var(--transition-fast);
}

.marker:hover .pin::before,
.marker.active .pin::before { opacity: 0.2; transform: scale(1.2); }

.marker .pin-img {
  display: block;
  object-fit: contain;
  background: transparent;
  filter: drop-shadow(0 4px 12px rgba(0, 0, 0, 0.4));
  pointer-events: none;
  transition: transform var(--transition-fast);
  position: relative;
  z-index: 1;
}

.marker:hover .pin-img { transform: translateY(-2px) scale(1.05); }

.marker--bandit .pin-img { width: calc(41px * var(--pin-scale)); height: calc(44px * var(--pin-scale)); }
.marker--stalker .pin-img { width: calc(43px * var(--pin-scale)); height: calc(41px * var(--pin-scale)); }
.marker--any .pin-img { width: calc(44px * var(--pin-scale)); height: calc(42px * var(--pin-scale)); }

.marker.pin-fallback .pin-img { display: none; }

.marker.pin-fallback .pin {
  width: 28px;
  height: 28px;
  border-radius: 50%;
  background: var(--bg-elevated);
  border: 2px solid var(--border-default);
  box-shadow: var(--shadow-md);
}

.marker.pin-fallback.marker--stalker .pin { border-color: var(--accent); background: var(--accent-muted); }
.marker.pin-fallback.marker--bandit .pin { border-color: #ef4444; background: rgba(239, 68, 68, 0.15); }

.marker .popover {
  position: absolute;
  left: 50%;
  bottom: calc(100% + 14px);
  transform: translateX(-50%);
  width: min(520px, 94vw);
  background: var(--bg-secondary);
  border: 1px solid var(--border-default);
  border-radius: var(--radius-xl);
  box-shadow: var(--shadow-lg);
  opacity: 0;
  visibility: hidden;
  transition: opacity var(--transition-fast), visibility var(--transition-fast);
  z-index: 20;
  overflow: hidden;
  overflow-y: auto;
  overscroll-behavior: contain;
  touch-action: pan-y;
  -webkit-overflow-scrolling: touch;
}

[data-theme="light"] .marker .popover { background: #fff; }
.marker:focus-within .popover, .marker.active .popover { opacity: 1; visibility: visible; }

.popover::after {
  content: '';
  position: absolute;
  left: 50%;
  top: 100%;
  transform: translateX(-50%);
  border: 10px solid transparent;
  border-top-color: var(--bg-secondary);
  filter: drop-shadow(0 2px 0 var(--border-default));
}

[data-theme="light"] .popover::after { border-top-color: #fff; }

.marker .popover[data-pos="below"] { top: calc(100% + 14px); bottom: auto; }

.marker .popover[data-pos="below"]::after {
  top: auto;
  bottom: 100%;
  border: 10px solid transparent;
  border-bottom-color: var(--bg-secondary);
  filter: drop-shadow(0 -2px 0 var(--border-default));
}

[data-theme="light"] .marker .popover[data-pos="below"]::after { border-bottom-color: #fff; }

.q-grid { display: grid; grid-template-columns: 180px 1fr; gap: 16px; padding: 16px; }
.popover.compact .q-grid { grid-template-columns: 1fr; }

.q-left, .q-right { display: flex; flex-direction: column; gap: 12px; }

.q-thumb-xl {
  width: 100%;
  height: 140px;
  object-fit: cover;
  border-radius: var(--radius-lg);
  border: 1px solid var(--border-default);
  background: var(--bg-tertiary);
}

.q-title-l { font-size: 17px; font-weight: 700; color: var(--text-primary); line-height: 1.3; text-align: center; }
.q-badges { display: flex; justify-content: center; }

.q-badge {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 6px 12px;
  border-radius: 100px;
  font-size: 12px;
  font-weight: 600;
  border: 1px solid;
}

.q-badge.badge--stalker { background: var(--accent-muted); border-color: rgba(16, 185, 129, 0.3); color: var(--accent); }
.q-badge.badge--bandit { background: rgba(239, 68, 68, 0.1); border-color: rgba(239, 68, 68, 0.3); color: #f87171; }
[data-theme="light"] .q-badge.badge--bandit { color: #dc2626; }
.q-badge.badge--any { background: rgba(59, 130, 246, 0.1); border-color: rgba(59, 130, 246, 0.3); color: #60a5fa; }
[data-theme="light"] .q-badge.badge--any { color: #2563eb; }

.q-stats-inline { display: flex; justify-content: center; gap: 8px; flex-wrap: wrap; }

.stat-badge {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 6px 10px;
  background: var(--bg-tertiary);
  border: 1px solid var(--border-default);
  border-radius: var(--radius-md);
  font-size: 13px;
  font-weight: 600;
  color: var(--text-primary);
}

.stat-badge.money i { color: #f59e0b; }
.stat-badge.rep i { color: var(--accent); }

.q-desc-box { padding: 12px; background: var(--bg-tertiary); border: 1px solid var(--border-subtle); border-radius: var(--radius-md); }
.q-desc { font-size: 14px; line-height: 1.6; color: var(--text-secondary); }

.rw-panel-large { display: flex; flex-direction: column; gap: 10px; }

.rw-label {
  display: flex;
  align-items: center;
  gap: 10px;
  font-size: 11px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  color: var(--text-muted);
}

.rw-label::after { content: ''; flex: 1; height: 1px; background: var(--border-subtle); }

.rw-gallery { display: flex; flex-wrap: wrap; gap: 8px; }
.rw-gallery.grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }

.rw-large {
  display: grid;
  grid-template-columns: auto 1fr auto;
  align-items: center;
  gap: 10px;
  padding: 8px;
  background: var(--bg-tertiary);
  border: 1px solid var(--border-default);
  border-radius: var(--radius-md);
  transition: border-color var(--transition-fast);
}

.rw-large:hover { border-color: var(--border-strong); }

.rw-large img {
  width: 48px;
  height: 48px;
  border-radius: var(--radius-sm);
  border: 1px solid var(--border-default);
  object-fit: cover;
  background: var(--bg-primary);
}

.rw-large .lbl {
  font-size: 12px;
  font-weight: 500;
  color: var(--text-primary);
  line-height: 1.3;
  overflow: hidden;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
}

.rw-large .qty {
  padding: 4px 8px;
  background: var(--bg-secondary);
  border: 1px solid var(--border-default);
  border-radius: var(--radius-sm);
  font-family: var(--font-mono);
  font-size: 11px;
  font-weight: 600;
  color: var(--text-secondary);
}

.rw-large.rarity-lockpick img { border-color: #e6e6e6; box-shadow: 0 0 12px rgba(230, 230, 230, 0.3); }
.rw-large.rarity-newbie img { border-color: #9DEB9D; box-shadow: 0 0 12px rgba(157, 235, 157, 0.3); }
.rw-large.rarity-stalker img { border-color: #9F9FED; box-shadow: 0 0 12px rgba(159, 159, 237, 0.3); }
.rw-large.rarity-veteran img { border-color: #BF5BAD; box-shadow: 0 0 12px rgba(191, 91, 173, 0.3); }
.rw-large.rarity-master img { border-color: #EA9D9E; box-shadow: 0 0 12px rgba(234, 157, 158, 0.3); }

.rw-large.compact { padding: 6px; }
.rw-large.compact img { width: 40px; height: 40px; }
.rw-large.compact .lbl { font-size: 11px; }

.q-actions { margin-top: auto; padding-top: 4px; }

.q-actions .btn {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  width: 100%;
  padding: 12px 16px;
  background: var(--accent);
  border: none;
  border-radius: var(--radius-md);
  color: #fff;
  font-size: 14px;
  font-weight: 600;
  text-decoration: none;
  transition: all var(--transition-fast);
}

.q-actions .btn:hover { background: var(--accent-hover); transform: translateY(-1px); }
.q-actions .btn i { font-size: 14px; }

.global-tooltip {
  position: fixed;
  z-index: 9999;
  pointer-events: none;
  opacity: 0;
  visibility: hidden;
  transition: opacity 0.15s ease, visibility 0.15s ease;
  padding: 8px 12px;
  max-width: 220px;
  width: max-content;
  background: var(--bg-primary);
  border: 1px solid var(--border-default);
  border-radius: var(--radius-md);
  box-shadow: var(--shadow-lg);
  font-size: 12px;
  font-weight: 500;
  line-height: 1.4;
  color: var(--text-primary);
  text-align: center;
  white-space: normal;
  word-wrap: break-word;
}

.global-tooltip::after {
  content: '';
  position: absolute;
  top: 100%;
  left: 50%;
  transform: translateX(-50%);
  border: 6px solid transparent;
  border-top-color: var(--bg-primary);
}

.global-tooltip.visible { opacity: 1; visibility: visible; }

.marker .popover::-webkit-scrollbar {
  width: 6px;
}

.marker .popover::-webkit-scrollbar-track {
  background: var(--bg-tertiary);
  border-radius: 3px;
}

.marker .popover::-webkit-scrollbar-thumb {
  background: var(--border-strong);
  border-radius: 3px;
}

.marker .popover::-webkit-scrollbar-thumb:hover {
  background: var(--accent);
}

.marker .popover.scrollable {
  overflow-y: auto;
}

.chip-event .chip-dot { 
  background: linear-gradient(135deg, #f59e0b, #ef4444); 
}

.marker--event .pin-img { 
  width: calc(44px * var(--pin-scale)); 
  height: calc(42px * var(--pin-scale)); 
}

.marker.pin-fallback.marker--event .pin { 
  border-color: #f59e0b; 
  background: rgba(245, 158, 11, 0.15); 
}

.q-badge.badge--event { 
  background: rgba(245, 158, 11, 0.1); 
  border-color: rgba(245, 158, 11, 0.3); 
  color: #fbbf24; 
}

[data-theme="light"] .q-badge.badge--event { 
  background: rgba(217, 119, 6, 0.12);
  border-color: rgba(217, 119, 6, 0.35);
  color: #d97706; 
}

@media (max-width: 768px) {
  .map-controls { top: 12px; left: 12px; max-width: calc(100% - 24px); padding: 8px 10px; gap: 8px; }
  .control-label span { display: none; }
  .control-select { min-width: 0; flex: 1; padding: 8px 32px 8px 12px; font-size: 13px; }
  .control-divider { height: 24px; }
  .control-btn { width: 32px; height: 32px; }
  .zoom-display { min-width: 44px; padding: 6px 8px; font-size: 12px; }
  .fit-btn { display: none; }
  .map-legend { bottom: 12px; left: 12px; padding: 6px 10px; gap: 6px; }
  .legend-chip { padding: 6px 10px; font-size: 12px; gap: 6px; }
  .chip-dot { width: 8px; height: 8px; }
  .map-hint { display: none; }
  .q-grid { grid-template-columns: 1fr; padding: 12px; gap: 12px; }
  .q-thumb-xl { height: 120px; }
  .rw-gallery.grid-2 { grid-template-columns: 1fr; }
  .popover::after { display: none; }
}

@media (max-width: 480px) {
  .map-controls { flex-wrap: wrap; }
  .location-select { flex: 1 1 100%; }
  .control-divider { display: none; }
  .zoom-controls { flex: 1; justify-content: center; }
  .legend-chip span { display: none; }
  .legend-chip { padding: 8px; }
  .chip-dot { width: 12px; height: 12px; }
}

@media (prefers-reduced-motion: reduce) {
  .marker .pin-img, .marker .popover, .marker .pin::before { transition: none; }
}

@media (max-width: 768px) {
  .marker .popover {
    max-height: 70vh;
    max-height: 70dvh;
  }
  
  .marker .popover .q-grid {
    max-height: 100%;
    overflow-y: auto;
  }
}
